/**
 * Jogo Educacional: Meu Nome na Hist√≥ria
 * Permite que crian√ßas descubram como seus nomes eram escritos em grego e latim antigos
 * Desenvolvido para crian√ßas de 4-6 anos
 */

// Base de dados de nomes com translitera√ß√µes
const nameDatabase = {
    // Nomes masculinos
    "jo√£o": { greek: "·º∏œâŒ¨ŒΩŒΩŒ∑œÇ", latin: "Ioannes", pronunciation: { greek: "ee-oh-AH-nees", latin: "ee-oh-AH-nes" } },
    "pedro": { greek: "Œ†Œ≠œÑœÅŒøœÇ", latin: "Petrus", pronunciation: { greek: "PEH-tros", latin: "PEH-trus" } },
    "lucas": { greek: "ŒõŒøœÖŒ∫·æ∂œÇ", latin: "Lucas", pronunciation: { greek: "loo-KAHS", latin: "LOO-kas" } },
    "paulo": { greek: "Œ†Œ±·ø¶ŒªŒøœÇ", latin: "Paulus", pronunciation: { greek: "PAH-oo-los", latin: "PAH-oo-lus" } },
    "marcos": { greek: "ŒúŒ¨œÅŒ∫ŒøœÇ", latin: "Marcus", pronunciation: { greek: "MAR-kos", latin: "MAR-kus" } },
    "mateus": { greek: "ŒúŒ±œÑŒ∏Œ±·øñŒøœÇ", latin: "Matthaeus", pronunciation: { greek: "mat-THAH-ee-os", latin: "mat-THAH-eh-us" } },
    "andr√©": { greek: "·ºàŒΩŒ¥œÅŒ≠Œ±œÇ", latin: "Andreas", pronunciation: { greek: "an-DREH-as", latin: "an-DREH-as" } },
    "felipe": { greek: "Œ¶ŒØŒªŒπœÄœÄŒøœÇ", latin: "Philippus", pronunciation: { greek: "FEE-lip-pos", latin: "fee-LIP-pus" } },
    "gabriel": { greek: "ŒìŒ±Œ≤œÅŒπŒÆŒª", latin: "Gabriel", pronunciation: { greek: "ga-vree-EHL", latin: "GA-bree-el" } },
    "miguel": { greek: "ŒúŒπœáŒ±ŒÆŒª", latin: "Michael", pronunciation: { greek: "mee-khah-EHL", latin: "MEE-khah-el" } },
    
    // Nomes femininos
    "maria": { greek: "ŒúŒ±œÅŒØŒ±", latin: "Maria", pronunciation: { greek: "ma-REE-ah", latin: "ma-REE-ah" } },
    "ana": { greek: "·ºåŒΩŒΩŒ±", latin: "Anna", pronunciation: { greek: "AH-na", latin: "AH-na" } },
    "j√∫lia": { greek: "·º∏ŒøœÖŒªŒØŒ±", latin: "Iulia", pronunciation: { greek: "ee-oo-LEE-ah", latin: "YOO-lee-ah" } },
    "helena": { greek: "·ºôŒªŒ≠ŒΩŒ∑", latin: "Helena", pronunciation: { greek: "heh-LEH-nee", latin: "heh-LEH-na" } },
    "sofia": { greek: "Œ£ŒøœÜŒØŒ±", latin: "Sophia", pronunciation: { greek: "so-FEE-ah", latin: "so-FEE-ah" } },
    "clara": { greek: "ŒöŒªŒ¨œÅŒ±", latin: "Clara", pronunciation: { greek: "KLAH-ra", latin: "KLAH-ra" } },
    "beatriz": { greek: "ŒíŒµŒ±œÑœÅŒØŒ∫Œ∑", latin: "Beatrix", pronunciation: { greek: "veh-ah-TREE-kee", latin: "beh-AH-triks" } },
    "isabel": { greek: "·º∏œÉŒ±Œ≤Œ≠ŒªŒªŒ±", latin: "Isabella", pronunciation: { greek: "ee-sa-VEH-la", latin: "ee-sa-BEH-la" } },
    "catarina": { greek: "Œë·º∞Œ∫Œ±œÑŒµœÅŒØŒΩŒ∑", latin: "Catharina", pronunciation: { greek: "ah-ee-ka-teh-REE-nee", latin: "ka-tha-REE-na" } },
    "b√°rbara": { greek: "ŒíŒ±œÅŒ≤Œ¨œÅŒ±", latin: "Barbara", pronunciation: { greek: "var-VAH-ra", latin: "BAR-ba-ra" } }
};

// Regras de translitera√ß√£o para nomes n√£o encontrados
const transliterationRules = {
    greek: {
        'a': 'Œ±', 'b': 'Œ≤', 'c': 'Œ∫', 'd': 'Œ¥', 'e': 'Œµ', 'f': 'œÜ', 'g': 'Œ≥', 'h': 'Œ∑',
        'i': 'Œπ', 'j': 'Œπ', 'k': 'Œ∫', 'l': 'Œª', 'm': 'Œº', 'n': 'ŒΩ', 'o': 'Œø', 'p': 'œÄ',
        'q': 'Œ∫', 'r': 'œÅ', 's': 'œÉ', 't': 'œÑ', 'u': 'œÖ', 'v': 'Œ≤', 'w': 'œâ', 'x': 'Œæ',
        'y': 'œÖ', 'z': 'Œ∂', '√£': 'Œ±', '√°': 'Œ±', '√†': 'Œ±', '√¢': 'Œ±', '√©': 'Œµ', '√™': 'Œµ',
        '√≠': 'Œπ', '√≥': 'Œø', '√¥': 'Œø', '√µ': 'Œø', '√∫': 'œÖ', '√ß': 'œÉ'
    },
    latin: {
        'a': 'a', 'b': 'b', 'c': 'c', 'd': 'd', 'e': 'e', 'f': 'f', 'g': 'g', 'h': 'h',
        'i': 'i', 'j': 'i', 'k': 'k', 'l': 'l', 'm': 'm', 'n': 'n', 'o': 'o', 'p': 'p',
        'q': 'qu', 'r': 'r', 's': 's', 't': 't', 'u': 'u', 'v': 'v', 'w': 'v', 'x': 'x',
        'y': 'y', 'z': 'z', '√£': 'a', '√°': 'a', '√†': 'a', '√¢': 'a', '√©': 'e', '√™': 'e',
        '√≠': 'i', '√≥': 'o', '√¥': 'o', '√µ': 'o', '√∫': 'u', '√ß': 'c'
    }
};

// Elementos DOM
let currentScreen = 'welcome-screen';
let currentName = '';
let currentResult = null;

// Inicializa√ß√£o do jogo
document.addEventListener('DOMContentLoaded', function() {
    initializeGame();
    setupEventListeners();
    playBackgroundMusic();
});

/**
 * Inicializa o jogo mostrando a tela de boas-vindas
 */
function initializeGame() {
    showScreen('welcome-screen');
    console.log('üèõÔ∏è Jogo "Meu Nome na Hist√≥ria" iniciado!');
}

/**
 * Configura todos os event listeners
 */
function setupEventListeners() {
    // Bot√£o de in√≠cio
    document.getElementById('start-btn').addEventListener('click', function() {
        playClickSound();
        showScreen('input-screen');
        setTimeout(() => {
            document.getElementById('name-input').focus();
        }, 500);
    });

    // Bot√£o de busca
    document.getElementById('search-btn').addEventListener('click', function() {
        const name = document.getElementById('name-input').value.trim();
        if (name) {
            searchName(name);
        } else {
            showMessage('Por favor, digite um nome!', 'warning');
        }
    });

    // Enter no input
    document.getElementById('name-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            document.getElementById('search-btn').click();
        }
    });

    // Bot√£o voltar
    document.getElementById('back-to-welcome').addEventListener('click', function() {
        playClickSound();
        showScreen('welcome-screen');
        document.getElementById('name-input').value = '';
    });

    // Bot√£o tentar novamente
    document.getElementById('try-again-btn').addEventListener('click', function() {
        playClickSound();
        showScreen('input-screen');
        document.getElementById('name-input').value = '';
        setTimeout(() => {
            document.getElementById('name-input').focus();
        }, 500);
    });

    // Bot√µes de pron√∫ncia
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('pronounce-btn')) {
            const lang = e.target.getAttribute('data-lang');
            pronounceName(lang);
        }
    });

    // Bot√£o de certificado
    document.getElementById('certificate-btn').addEventListener('click', function() {
        playClickSound();
        generateCertificate();
    });

    // Anima√ß√µes dos mascotes
    setupMascotAnimations();
}

/**
 * Mostra uma tela espec√≠fica
 */
function showScreen(screenId) {
    // Esconde todas as telas
    document.querySelectorAll('.screen').forEach(screen => {
        screen.classList.remove('active');
    });
    
    // Mostra a tela solicitada
    document.getElementById(screenId).classList.add('active');
    currentScreen = screenId;
    
    // Adiciona anima√ß√µes espec√≠ficas da tela
    addScreenAnimations(screenId);
}

/**
 * Adiciona anima√ß√µes espec√≠ficas para cada tela
 */
function addScreenAnimations(screenId) {
    const screen = document.getElementById(screenId);
    
    switch(screenId) {
        case 'welcome-screen':
            animateWelcomeScreen();
            break;
        case 'input-screen':
            animateInputScreen();
            break;
        case 'result-screen':
            animateResultScreen();
            break;
    }
}

/**
 * Anima a tela de boas-vindas
 */
function animateWelcomeScreen() {
    const title = document.querySelector('.game-title');
    const mascot = document.querySelector('.owl-mascot');
    const button = document.getElementById('start-btn');
    
    // Reset das anima√ß√µes
    title.style.opacity = '0';
    mascot.style.opacity = '0';
    button.style.opacity = '0';
    
    // Anima√ß√£o sequencial
    setTimeout(() => {
        title.style.transition = 'opacity 1s ease-in-out';
        title.style.opacity = '1';
    }, 200);
    
    setTimeout(() => {
        mascot.style.transition = 'opacity 1s ease-in-out';
        mascot.style.opacity = '1';
    }, 800);
    
    setTimeout(() => {
        button.style.transition = 'opacity 1s ease-in-out';
        button.style.opacity = '1';
    }, 1400);
}

/**
 * Anima a tela de input
 */
function animateInputScreen() {
    const elements = document.querySelectorAll('#input-screen .content-container > *');
    elements.forEach((element, index) => {
        element.style.opacity = '0';
        element.style.transform = 'translateY(30px)';
        
        setTimeout(() => {
            element.style.transition = 'all 0.6s ease-out';
            element.style.opacity = '1';
            element.style.transform = 'translateY(0)';
        }, index * 200);
    });
}

/**
 * Anima a tela de resultado
 */
function animateResultScreen() {
    const elements = document.querySelectorAll('#result-screen .content-container > *');
    elements.forEach((element, index) => {
        element.style.opacity = '0';
        element.style.transform = 'translateY(30px)';
        
        setTimeout(() => {
            element.style.transition = 'all 0.6s ease-out';
            element.style.opacity = '1';
            element.style.transform = 'translateY(0)';
        }, index * 300);
    });
}

/**
 * Busca o nome no banco de dados
 */
function searchName(name) {
    playClickSound();
    currentName = name;
    
    // Mostra loading
    showLoading();
    
    // Simula tempo de busca para criar suspense
    setTimeout(() => {
        const normalizedName = name.toLowerCase().trim();
        let result;
        
        if (nameDatabase[normalizedName]) {
            // Nome encontrado no banco
            result = {
                found: true,
                original: name,
                greek: nameDatabase[normalizedName].greek,
                latin: nameDatabase[normalizedName].latin,
                pronunciation: nameDatabase[normalizedName].pronunciation
            };
        } else {
            // Nome n√£o encontrado - usar translitera√ß√£o
            result = {
                found: false,
                original: name,
                greek: transliterateName(normalizedName, 'greek'),
                latin: transliterateName(normalizedName, 'latin'),
                pronunciation: {
                    greek: generatePronunciation(normalizedName, 'greek'),
                    latin: generatePronunciation(normalizedName, 'latin')
                }
            };
        }
        
        currentResult = result;
        hideLoading();
        showResult(result);
        
    }, 1500); // 1.5 segundos de "busca"
}

/**
 * Translitera√ß√£o de nomes n√£o encontrados
 */
function transliterateName(name, language) {
    const rules = transliterationRules[language];
    let result = '';
    
    for (let char of name) {
        result += rules[char] || char;
    }
    
    // Capitaliza a primeira letra para latim
    if (language === 'latin') {
        result = result.charAt(0).toUpperCase() + result.slice(1);
    }
    
    return result;
}

/**
 * Gera pron√∫ncia aproximada
 */
function generatePronunciation(name, language) {
    // Simplifica√ß√£o para demonstra√ß√£o
    if (language === 'greek') {
        return name.split('').join('-').toUpperCase();
    } else {
        return name.charAt(0).toUpperCase() + name.slice(1).toLowerCase();
    }
}

/**
 * Mostra o resultado da busca
 */
function showResult(result) {
    // Preenche os elementos com os dados
    document.getElementById('original-name').textContent = result.original;
    document.getElementById('greek-name').textContent = result.greek;
    document.getElementById('latin-name').textContent = result.latin;
    
    // Adiciona informa√ß√£o se foi encontrado ou transliterado
    const greekCard = document.querySelector('.ancient-name-card.greek');
    const latinCard = document.querySelector('.ancient-name-card.latin');
    
    if (!result.found) {
        greekCard.classList.add('sparkle');
        latinCard.classList.add('sparkle');
        
        // Adiciona nota explicativa
        const note = document.createElement('p');
        note.style.fontSize = '0.8rem';
        note.style.color = '#666';
        note.style.marginTop = '10px';
        note.style.fontStyle = 'italic';
        note.textContent = '* Translitera√ß√£o aproximada';
        
        greekCard.appendChild(note.cloneNode(true));
        latinCard.appendChild(note);
    }
    
    // Anima as letras aparecendo
    animateLetters();
    
    // Toca som de sucesso
    playSuccessSound();
    
    // Mostra a tela de resultado
    showScreen('result-screen');
}

/**
 * Anima as letras aparecendo uma por uma
 */
function animateLetters() {
    const greekText = document.getElementById('greek-name');
    const latinText = document.getElementById('latin-name');
    
    animateTextLetters(greekText);
    setTimeout(() => animateTextLetters(latinText), 500);
}

/**
 * Anima as letras de um texto espec√≠fico
 */
function animateTextLetters(element) {
    const text = element.textContent;
    element.textContent = '';
    
    for (let i = 0; i < text.length; i++) {
        setTimeout(() => {
            element.textContent += text[i];
            playLetterSound();
        }, i * 150);
    }
}

/**
 * Pronuncia o nome na l√≠ngua especificada
 */
function pronounceName(language) {
    if (!currentResult) return;
    
    playClickSound();
    
    // Usa Web Speech API se dispon√≠vel
    if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance();
        
        if (language === 'greek') {
            utterance.text = currentResult.pronunciation.greek;
            utterance.lang = 'el-GR'; // Grego
        } else {
            utterance.text = currentResult.pronunciation.latin;
            utterance.lang = 'la'; // Latim (pode n√£o estar dispon√≠vel)
        }
        
        utterance.rate = 0.7; // Mais devagar para crian√ßas
        utterance.pitch = 1.2; // Tom mais agudo
        
        speechSynthesis.speak(utterance);
    } else {
        // Fallback: mostra a pron√∫ncia em texto
        const pronunciation = language === 'greek' ? 
            currentResult.pronunciation.greek : 
            currentResult.pronunciation.latin;
            
        showMessage(`Pron√∫ncia: ${pronunciation}`, 'info');
    }
}

/**
 * Gera certificado em PDF
 */
function generateCertificate() {
    if (!currentResult) return;
    
    playClickSound();
    
    // Cria o conte√∫do do certificado
    const certificateContent = `
        üèõÔ∏è CERTIFICADO DE DESCOBERTA HIST√ìRICA üèõÔ∏è
        
        Certificamos que ${currentResult.original} descobriu seu nome na antiguidade:
        
        Em Grego Koin√© (s√©c. I d.C.): ${currentResult.greek}
        Em Latim Cl√°ssico: ${currentResult.latin}
        
        Parab√©ns pela sua jornada atrav√©s da hist√≥ria!
        
        Data: ${new Date().toLocaleDateString('pt-BR')}
        
        ‚≠ê Jogo Educacional "Meu Nome na Hist√≥ria" ‚≠ê
    `;
    
    // Cria um blob com o conte√∫do
    const blob = new Blob([certificateContent], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    
    // Cria link para download
    const link = document.createElement('a');
    link.href = url;
    link.download = `certificado_${currentResult.original.toLowerCase()}.txt`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Limpa a URL
    URL.revokeObjectURL(url);
    
    showMessage('Certificado baixado com sucesso! üéâ', 'success');
}

/**
 * Configura anima√ß√µes dos mascotes
 */
function setupMascotAnimations() {
    // Anima√ß√£o de piscar para a coruja
    setInterval(() => {
        const eyes = document.querySelectorAll('.eye');
        eyes.forEach(eye => {
            eye.style.transform = 'scaleY(0.1)';
            setTimeout(() => {
                eye.style.transform = 'scaleY(1)';
            }, 150);
        });
    }, 4000);
    
    // Movimento sutil dos mascotes
    const mascots = document.querySelectorAll('.owl-mascot, .scribe-mascot');
    mascots.forEach(mascot => {
        setInterval(() => {
            const randomX = (Math.random() - 0.5) * 10;
            const randomY = (Math.random() - 0.5) * 5;
            mascot.style.transform = `translate(${randomX}px, ${randomY}px)`;
            
            setTimeout(() => {
                mascot.style.transform = 'translate(0, 0)';
            }, 1000);
        }, 5000 + Math.random() * 3000);
    });
}

/**
 * Mostra loading
 */
function showLoading() {
    const inputScreen = document.getElementById('input-screen');
    inputScreen.classList.add('loading');
}

/**
 * Esconde loading
 */
function hideLoading() {
    const inputScreen = document.getElementById('input-screen');
    inputScreen.classList.remove('loading');
}

/**
 * Mostra mensagem para o usu√°rio
 */
function showMessage(message, type = 'info') {
    // Remove mensagem anterior se existir
    const existingMessage = document.querySelector('.game-message');
    if (existingMessage) {
        existingMessage.remove();
    }
    
    // Cria nova mensagem
    const messageDiv = document.createElement('div');
    messageDiv.className = `game-message ${type}`;
    messageDiv.textContent = message;
    
    // Estilos da mensagem
    Object.assign(messageDiv.style, {
        position: 'fixed',
        top: '20px',
        left: '50%',
        transform: 'translateX(-50%)',
        background: type === 'success' ? '#4CAF50' : 
                   type === 'warning' ? '#FF9800' : '#2196F3',
        color: 'white',
        padding: '15px 25px',
        borderRadius: '25px',
        fontFamily: 'Comic Neue, cursive',
        fontSize: '1rem',
        fontWeight: 'bold',
        boxShadow: '0 4px 12px rgba(0,0,0,0.3)',
        zIndex: '1000',
        animation: 'messageSlide 0.5s ease-out'
    });
    
    // Adiciona anima√ß√£o CSS
    const style = document.createElement('style');
    style.textContent = `
        @keyframes messageSlide {
            from { opacity: 0; transform: translateX(-50%) translateY(-20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
    `;
    document.head.appendChild(style);
    
    document.body.appendChild(messageDiv);
    
    // Remove ap√≥s 3 segundos
    setTimeout(() => {
        messageDiv.style.animation = 'messageSlide 0.5s ease-out reverse';
        setTimeout(() => {
            if (messageDiv.parentNode) {
                messageDiv.remove();
            }
        }, 500);
    }, 3000);
}

/**
 * Efeitos sonoros (usando Web Audio API ou sons sint√©ticos)
 */
function playClickSound() {
    playTone(800, 100, 0.1);
}

function playSuccessSound() {
    // Sequ√™ncia de tons para som de sucesso
    playTone(523, 200, 0.2); // D√≥
    setTimeout(() => playTone(659, 200, 0.2), 100); // Mi
    setTimeout(() => playTone(784, 300, 0.2), 200); // Sol
}

function playLetterSound() {
    playTone(1000 + Math.random() * 500, 50, 0.05);
}

function playBackgroundMusic() {
    // M√∫sica de fundo sutil (opcional)
    // Implementa√ß√£o simplificada
}

/**
 * Gera um tom usando Web Audio API
 */
function playTone(frequency, duration, volume = 0.1) {
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0, audioContext.currentTime);
        gainNode.gain.linearRampToValueAtTime(volume, audioContext.currentTime + 0.01);
        gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration / 1000);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + duration / 1000);
    } catch (error) {
        console.log('Audio n√£o suportado:', error);
    }
}

/**
 * Utilit√°rios para desenvolvimento e debug
 */
function addNameToDatabase(name, greekForm, latinForm, greekPronunciation, latinPronunciation) {
    nameDatabase[name.toLowerCase()] = {
        greek: greekForm,
        latin: latinForm,
        pronunciation: {
            greek: greekPronunciation,
            latin: latinPronunciation
        }
    };
    console.log(`Nome ${name} adicionado ao banco de dados!`);
}

// Exporta fun√ß√µes para uso externo (se necess√°rio)
window.GameFunctions = {
    addNameToDatabase,
    searchName,
    showScreen,
    currentResult: () => currentResult
};

// Log de inicializa√ß√£o
console.log('üéÆ Script do jogo carregado com sucesso!');
console.log('üìö Banco de dados cont√©m', Object.keys(nameDatabase).length, 'nomes');

// Easter egg para desenvolvedores
console.log('ü•ö Easter egg: Digite "debug" como nome para ver informa√ß√µes t√©cnicas!');

// Tratamento especial para o nome "debug"
const originalSearchName = window.searchName || searchName;
window.searchName = function(name) {
    if (name.toLowerCase() === 'debug') {
        console.log('üîß Modo Debug Ativado!');
        console.log('üìä Estat√≠sticas do jogo:', {
            nomesNoBanco: Object.keys(nameDatabase).length,
            telaAtual: currentScreen,
            ultimoResultado: currentResult
        });
        showMessage('Modo debug ativado! Veja o console.', 'info');
        return;
    }
    originalSearchName(name);
};